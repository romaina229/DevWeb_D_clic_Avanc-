// src/services/auth.jsimport api from './api';
import api from './api';
import axios from "axios";


axios.defaults.baseURL = "http://127.0.0.1:8000";
axios.defaults.withCredentials = true;
axios.defaults.headers.common["Accept"] = "application/json";



export const authService = {
    login: async (email, password) => {
        try {
            console.log('1. Starting login process...');
            
            // Étape 1 : CSRF token
            console.log('2. Getting CSRF token...');
            const csrfResponse = await axios.get(
                'http://127.0.0.1:8000/sanctum/csrf-cookie',
                { withCredentials: true }
            );
            console.log('CSRF response:', csrfResponse.status);
            
            // Étape 2 : Login
            console.log('3. Sending login request...');
            const loginData = {
                email: email.trim().toLowerCase(),
                password: password
            };
            console.log('Login data:', loginData);
            
            const response = await axios.post(
                'http://127.0.0.1:8000/api/login',
                loginData,
                {
                    withCredentials: true,
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'X-XSRF-TOKEN': getCookie('XSRF-TOKEN')
                    }
                }
            );
            
            console.log('4. Login successful:', response.data);
            return response.data;
            
        } catch (error) {
            console.error('Login failed:', {
                status: error.response?.status,
                data: error.response?.data,
                config: error.config
            });
            throw error;
        }
    },
    register: async (userData) => {
        try {
            // Assurer que les données sont au bon format
            await axios.get('/sanctum/csrf-cookie',{
                withCredentials: true
            });
            const formattedData = {
                name: userData.name,
                email: userData.email.trim().toLowerCase(),
                password: userData.password,
                password_confirmation: userData.password_confirmation || userData.confirmPassword,
                role: userData.role || 'technicien'
            };

            console.log('Tentative d\'inscription avec:', formattedData);

            const response = await api.post('/register', formattedData);
            
            if (response.data.token) {
                localStorage.setItem('token', response.data.token);
                localStorage.setItem('user', JSON.stringify(response.data.user));
            }
            return response.data;
        } catch (error) {
            console.error('Erreur d\'inscription:', error);
            throw error;
        }
    },

    logout: async () => {
        try {
            const token = localStorage.getItem('token');
            if (token) {
                // Essayer de notifier le backend
                try {
                    await axios.post('/logout', {}, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                } catch (apiError) {
                    console.warn('Erreur lors de la déconnexion API:', apiError);
                }
            }
            
            // Toujours nettoyer le localStorage
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            
            return { success: true };
        } catch (error) {
            console.error('Erreur lors de la déconnexion:', error);
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            throw error;
        }
    },

    getCurrentUser: () => {
        try {
            const userStr = localStorage.getItem('user');
            return userStr ? JSON.parse(userStr) : null;
        } catch (error) {
            console.error('Erreur lors de la récupération de l\'utilisateur:', error);
            return null;
        }
    },

    isAuthenticated: () => {
        return !!localStorage.getItem('token');
    },

    getToken: () => {
        return localStorage.getItem('token');
    }
}

// Helper pour récupérer les cookies
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}